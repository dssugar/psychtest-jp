/**
 * Rosenberg Self-Esteem Scale (RSES) - Scoring & Configuration
 *
 * Rosenberg自尊心尺度の採点とレベル判定
 *
 * スコア範囲: 10-40点
 * - 10-14点: 非常に低い自尊心
 * - 15-19点: 低い自尊心
 * - 20-29点: 平均的な自尊心
 * - 30-34点: 高い自尊心
 * - 35-40点: 非常に高い自尊心
 *
 * @reference Rosenberg, M. (1965). Society and the adolescent self-image.
 *            Princeton, NJ: Princeton University Press.
 */

import {
  rosenbergQuestions,
  scaleOptions,
  scaleInfo,
  scoreRanges,
} from "@/data/rosenberg-questions";
import type { TestConfig } from "./types";
import { validateAnswerPattern as validateCommon } from "./validation";
import type { DimensionData } from "@/lib/og-design/types";
import { TEST_COLOR_MAP } from "@/lib/og-design/constants";

// ============================================================================
// Types & Interfaces
// ============================================================================

// 詳細解釈の構造（Phase 5準拠）
export interface DetailedInterpretation {
  summary: string;           // 要約（約200字）
  dailyLifeImpact: string;   // 日常生活への影響（約500字）
  psychBackground: string;   // 心理学的背景（約300字）
  practicalAdvice: string;   // 実用的アドバイス（約500字）
}

export interface RosenbergResult {
  rawScore: number;
  percentageScore: number;
  level: "low" | "medium" | "high";  // 3段階に変更
  // NOTE: interpretation と detailedInterpretation は保存せず、
  // 表示時に getInterpretation() / getDetailedInterpretation() で動的生成
}

// ============================================================================
// Scoring Logic
// ============================================================================

/**
 * Rosenberg自尊心尺度のスコア計算
 * @param answers 各質問への回答（1-4）
 * @returns 計算結果
 */
export function calculateRosenbergScore(answers: number[]): RosenbergResult {
  if (answers.length !== 10) {
    throw new Error("回答数が正しくありません。10問の回答が必要です。");
  }

  // スコア計算（逆転項目を考慮）
  let rawScore = 0;
  for (let i = 0; i < answers.length; i++) {
    const answer = answers[i];
    const question = rosenbergQuestions[i];

    if (answer < 1 || answer > 4) {
      throw new Error(`無効な回答値: ${answer}. 1-4の範囲で回答してください。`);
    }

    // 逆転項目の場合は反転（1→4, 2→3, 3→2, 4→1）
    const score = question.reverse ? 5 - answer : answer;
    rawScore += score;
  }

  // パーセンテージスコア（10-40を0-100に変換）
  const percentageScore = ((rawScore - 10) / 30) * 100;

  // レベル分類（data/rosenberg-questions.tsのscoreRangesを使用）
  let level: RosenbergResult["level"] = "medium";  // デフォルト
  for (const range of scoreRanges) {
    if (rawScore >= range.min && rawScore <= range.max) {
      level = range.level;
      break;
    }
  }

  return {
    rawScore,
    percentageScore: Math.round(percentageScore * 10) / 10,
    level,
  };
}

/**
 * 簡潔な解釈文を取得（結果サマリー用）
 * 表示時に動的生成するため、localStorage に保存しない
 */
export function getInterpretation(
  level: RosenbergResult["level"],
  rawScore: number,
  percentageScore: number
): string {
  const interpretations = {
    low: `自尊心が低めの範囲です（スコア: ${rawScore}/40, ${percentageScore.toFixed(1)}%）。自分自身を肯定的に捉えることが難しく、自己価値を感じにくい傾向があります。この状態が続く場合は、専門家に相談することも検討してください。約16%の人がこの範囲に該当します。`,
    medium: `自尊心が平均的な範囲です（スコア: ${rawScore}/40, ${percentageScore.toFixed(1)}%）。自分自身に対して概ね肯定的な態度を持っていますが、時には自己評価が揺らぐこともあるでしょう。約68%の人がこの範囲に当てはまります。`,
    high: `自尊心が高めの範囲です（スコア: ${rawScore}/40, ${percentageScore.toFixed(1)}%）。自分自身を肯定的に捉え、自己価値をしっかりと感じています。約16%の人がこの範囲に該当し、精神的な健康の良好な基盤となります。`,
  };

  return interpretations[level];
}

/**
 * 詳細解釈を取得（Phase 5準拠）
 * 各レベル約1,500字の学術的根拠に基づいた解釈
 * 表示時に動的生成するため、localStorage に保存しない
 */
export function getDetailedInterpretation(
  level: RosenbergResult["level"],
  rawScore: number,
  percentageScore: number
): DetailedInterpretation {
  const interpretations: Record<RosenbergResult["level"], DetailedInterpretation> = {
    low: {
      summary: `自尊心が低い状態です（スコア: ${rawScore}/40点、${percentageScore.toFixed(1)}%）。自分自身を肯定的に捉えることが難しく、自己評価が低い傾向があります。日常生活において、自信のなさが様々な場面で影響を及ぼしています。この状態は将来的なメンタルヘルス問題のリスク因子となる可能性があるため、早期の対処が重要です。適切なセルフケアと、必要に応じた専門家のサポートにより、自尊心を高めることができます。`,

      dailyLifeImpact: `**対人関係**

自尊心が低いと、対人関係において複数の課題が生じます。自分の意見や感情を表現することに躊躇し、他者の期待に過度に応えようとする傾向があります。「自分の意見は重要ではない」という思い込みから、グループでの会話で受け身になりがちです。また、批判や拒絶に対して敏感になり、他者からの否定的なフィードバック（実際のものであれ、想像上のものであれ）に過剰に反応します。親密な関係では、「自分は愛されるに値しない」という不安から、パートナーへの過度な reassurance seeking（安心を求める行動）や、嫉妬が生じることがあります。一方で、自分の境界線を適切に設定することが難しく、他者の要求を断れずに疲弊することもあります。

**仕事・学業**

職場や学校では、自己疑念がパフォーマンスに影響します。新しいプロジェクトや責任を引き受けることに不安を感じ、「失敗したらどうしよう」という思考が先行します。実際には能力があるにもかかわらず、自己評価が低いため、挑戦を避け、成長の機会を逃すことがあります。会議やプレゼンテーションでは、自分のアイデアを共有することに躊躇し、貢献の機会を見過ごします。また、昇進や給与交渉において自己主張が弱くなり、キャリアの進展が遅れる可能性があります。Baumeister et al. (2003) の研究によれば、自尊心と仕事のパフォーマンスの因果関係は複雑で、成功が自尊心を高める側面が強いものの、低い自尊心は失敗後の粘り強さを低下させることが示されています。

**意思決定**

日常的な意思決定においても、自己信頼の低さが影響します。「自分の判断は間違っているかもしれない」という不安から、過度に悩み、決断を先延ばしにする傾向があります。重要な決定（転職、引っ越し、人間関係の変化）では、他者の意見に過度に依存し、自分の価値観や長期的な目標から逸脱した選択をしてしまうことがあります。また、完璧主義的な思考（「完璧な選択肢が見つかるまで決めない」）により、優柔不断が長期化することもあります。

**ストレス対処**

ストレス状況では、低い自尊心が脆弱性を高めます。高い自尊心を持つ人はストレスに対するバッファー（緩衝材）機能がありますが、低い自尊心ではこの保護機能が弱いため、ストレッサーの影響を受けやすくなります。軽微な挫折でも自己批判が強まり、「やっぱり自分はダメだ」という思考に陥りがちです。建設的な問題解決よりも、回避や諦めといった非適応的な対処法を選びやすくなります。`,

      psychBackground: `縦断研究により、低い自尊心は将来のメンタルヘルス問題のリスク因子であることが確立されています。Sowislo & Orth (2013) のメタ分析では、低い自尊心が後の時点でのうつ病および不安症の増加を有意に予測することが示されています（β = -.10）。重要なのは、この関係が逆方向よりも強いことです。つまり、うつや不安が自尊心を低下させる効果よりも、低い自尊心がうつや不安を引き起こす効果の方が大きいのです。これは、低い自尊心への早期介入の重要性を示唆しています。

また、低い自尊心は日常生活のストレス経験とも関連しています。研究によれば、自尊心が低い人は、より否定的な感情を経験し、肯定的な感情が少なく、ストレス重症度が高いことが日常生活の測定で確認されています。

Rosenbergの理論的枠組みでは、自尊心は他者からの評価の解釈（反映された評価）と社会的比較を通じて形成されます。低い自尊心を持つ人は、他者のフィードバックを過度に否定的に解釈し、社会的比較で自分を不利に位置づける認知的バイアスを持つ傾向があります。`,

      practicalAdvice: `**専門家への相談を検討**

スコアが15-19点の範囲にある場合、専門家への相談を検討することをお勧めします。特に以下のような症状がある場合は、早めの相談が有益です：

- 気分の落ち込みが2週間以上続いている
- 不安が日常生活に支障をきたしている
- 社会的活動や仕事・学業に明らかな支障がある

**エビデンスに基づく介入方法**

研究により効果が実証されている方法があります：

1. **自己コンパッション（Self-Compassion）の実践**: メタ分析により、自己コンパッションベースの介入が、うつ症状（g = 0.40）、不安症状（g = 0.46）、自己コンパッション（g = 0.52）の改善に中程度から大きな効果量を示すことが確認されています。自己批判を和らげ、自分自身に優しく接することを学びます。
   - **実践例**: 困難な状況に直面したとき、「自分はダメだ」という自己批判ではなく、「誰でも困難を経験する。今は辛いけれど、自分を責める必要はない」と自分に語りかけます。

2. **認知行動療法（CBT）的アプローチ**: 否定的な自動思考を特定し、より現実的でバランスの取れた思考に置き換える方法です。
   - **実践例**: 「自分には価値がない」という思考が浮かんだら、その根拠を検証し、反証（「過去に成功した経験」「他者から感謝されたこと」など）を探します。

3. **マインドフルネス瞑想**: 自己批判的な思考に巻き込まれず、現在の瞬間に注意を向ける訓練です。研究により、マインドフルネスの実践が自己コンパッションを高め、うつや不安の症状を軽減することが示されています。

**日常でできる小さなステップ**

- **強みの再発見**: 自分の強みや過去の成功体験をリストアップし、定期的に振り返ります。
- **小さな達成目標の設定**: 達成可能な小さな目標を設定し、それを達成することで自己効力感を徐々に高めます。
- **ポジティブなフィードバックの記録**: 他者からの肯定的なフィードバックを日記に記録し、自己批判が強まったときに読み返します。
- **自己比較ではなく、過去の自分との比較**: 他者と比較するのではなく、「過去の自分と比べてどう成長したか」に焦点を当てます。

**注意点**

- 自尊心の改善には時間がかかります。一朝一夕の変化を期待せず、継続的な取り組みが大切です。
- 完璧主義を手放すことも重要です。「完璧でなければ価値がない」という思考は、自尊心をさらに低下させます。`,
    },

    medium: {
      summary: `自尊心が平均的な状態です（スコア: ${rawScore}/40点、${percentageScore.toFixed(1)}%）。自分自身に対して概ね肯定的な態度を持っていますが、状況によっては自己評価が揺らぐこともあります。多くの人がこの範囲に当てはまり、正常な範囲と考えられます。現在の自尊心を維持しながら、さらに高めていく余地もあります。適切なセルフケアと自己理解を深めることで、より安定した自己価値感を育むことができます。`,

      dailyLifeImpact: `**対人関係**

平均的な自尊心を持つ人は、対人関係において比較的バランスの取れた態度を示します。自分の意見を表現することもできますが、他者の意見も尊重します。ただし、状況によっては自信が揺らぐことがあります。例えば、権威的な人物や専門家の前では、自分の意見を控えめに表現したり、批判を受けたときには一時的に自己疑念が強まったりすることがあります。親密な関係では、概ね健全なコミュニケーションが取れますが、ストレスの多い時期や葛藤が生じたときには、不安や自己疑念が表面化することがあります。多くの場合、時間の経過とともに自己評価は安定化します。

**仕事・学業**

職場や学校では、適度な自信を持って課題に取り組むことができます。新しい挑戦に対しても、過度な不安を感じることなく取り組めることが多いですが、非常に高い難易度のタスクや、過去に失敗した経験がある分野では、自信が揺らぐことがあります。Baumeister et al. (2003) の研究によれば、自尊心と学業成績の関係は複雑で、必ずしも高い自尊心が高い成績を直接引き起こすわけではありません。むしろ、成功体験が自尊心を高める側面が強いです。ただし、平均的な自尊心を持つ人は、失敗後も適度に粘り強く取り組むことができる傾向があります。

キャリアにおいては、昇進や新しい役割への挑戦において、適度な自信と慎重さのバランスを取ります。自己主張が必要な場面（給与交渉、自分の貢献のアピールなど）では、やや躊躇することがあるかもしれませんが、完全に避けるわけではありません。

**意思決定**

日常的な意思決定は概ねスムーズに行えます。重要な決定においては、適度に情報を収集し、自分の判断を信頼しつつも、他者の意見も参考にするバランスの取れたアプローチを取ります。ただし、非常に重要な人生の決定（キャリアの大きな転換、人間関係の重要な変化など）では、自己疑念が強まり、決断に時間がかかることがあります。完璧主義的な傾向が強い場合、「最善の選択」を求めて優柔不断になることもあります。

**ストレス対処**

ストレス状況に対する対処は、概ね適応的です。軽度から中程度のストレッサーには、問題解決的なアプローチを取ることができます。ただし、非常に強いストレスや長期的なストレス（失業、重要な喪失、健康問題など）に直面すると、自己評価が一時的に低下し、対処能力が弱まることがあります。研究によれば、高い自尊心はストレスに対するバッファー（緩衝材）として機能しますが、平均的な自尊心ではこの保護機能が部分的にしか働かない可能性があります。`,

      psychBackground: `平均的な自尊心（20-29点）は、人口の大多数が該当する正常範囲です。統計的には、ローゼンバーグ自尊心尺度のスコア分布において、平均値は約20-25点、標準偏差は5-6点程度とされており、このスコア範囲は平均付近からやや上に位置します。

重要な点として、自尊心は完全に安定した特性ではなく、状況や時間経過によって変動する側面を持ちます。Steyer et al. (1999) の Trait-State-Outcome モデルによれば、自尊心は特性的要素（比較的安定した個人差）と状態的要素（状況による変動）の両方を含みます。平均的な自尊心を持つ人は、ポジティブな出来事や成功体験により自尊心が一時的に高まり、ネガティブな出来事や失敗により一時的に低下するという変動を経験します。

また、文化的要因も重要です。日本の研究によれば、青年期は自尊心が低い傾向があり、成人期以降に徐々に上昇していくことが示されています。特に日本文化では、謙虚さが重視されるため、欧米と比較して自尊心スコアがやや低めに出る傾向があることが知られています。したがって、文化的文脈を考慮すると、日本人においてこのスコア範囲は十分に健康的であると言えます。`,

      practicalAdvice: `**現在の自尊心を維持する**

平均的な自尊心は健康的な範囲にありますが、さらに向上させる余地もあります。以下の方法で、現在の状態を維持しつつ、さらに高めることができます。

**自尊心をさらに高める方法**

1. **自己コンパッションの実践**: 研究により、自己コンパッション（自分自身に優しく接すること）が自尊心よりも優れた予測因子であることが示されています。自己批判が強まったとき、「誰でも失敗する。自分を責めるのではなく、学びの機会にしよう」と語りかけます。

2. **強みに基づく活動**: VIA Character Strengths（価値観・強み）の研究によれば、自分の強みを認識し、それを日常生活で活用することが、自尊心とウェルビーイングを高めます。自分の強み（例: 創造性、親切心、リーダーシップ、学習意欲など）を特定し、それを活かせる活動を増やします。

3. **マインドフルネス実践**: マインドフルネス瞑想は、自己批判的な思考パターンに気づき、それに巻き込まれない力を養います。1日5-10分の短い瞑想でも、継続することで効果が得られます。

4. **成長マインドセット**: 自分の能力は固定的ではなく、努力により成長できると考えることで、失敗を脅威ではなく学習の機会と捉えられるようになります。

**日常でできる小さなステップ**

- **感謝日記**: 毎日、その日に起こった良いことや感謝できることを3つ書き出します。これにより、ポジティブな側面に注意を向ける習慣が育ちます。
- **小さな挑戦**: 快適ゾーン（comfort zone）を少しだけ広げる小さな挑戦を定期的に行います。これにより、自己効力感が高まります。
- **ソーシャルサポートの活用**: 信頼できる友人や家族との良好な関係を維持します。研究により、ソーシャルサポートは自尊心とメンタルヘルスの保護因子であることが示されています。

**将来のリスクへの予防**

平均的な自尊心を持つ人でも、強いストレス（失業、喪失、健康問題など）により自尊心が一時的に低下することがあります。以下の予防的対策が有効です：

- **ストレス管理スキル**: 問題解決スキル、リラクゼーション技法、時間管理などを学び、ストレス耐性を高めます。
- **早期のセルフケア**: 自尊心が低下し始めたら、早めに対処します（専門家への相談、セルフヘルプ資源の活用など）。

**注意点**

- 自尊心を高めることと、自己中心的になることは別です。他者への配慮とバランスを取りながら、健全な自己価値感を育てることが大切です。
- 過度に高い自尊心（narcissistic self-esteem）は、対人関係の問題や現実検討能力の低下につながることがあります。適度でバランスの取れた自尊心が理想的です。`,
    },

    high: {
      summary: `自尊心が高い状態です（スコア: ${rawScore}/40点、${percentageScore.toFixed(1)}%）。自分自身を肯定的に捉え、自己価値をしっかりと感じています。この高い自尊心は精神的健康の重要な基盤となり、ストレスに対する保護因子として機能します。対人関係や仕事・学業において、適切な自信を持って取り組むことができ、困難な状況にも粘り強く対処できます。この状態を維持し、さらに健全な方向で発展させていくことが大切です。`,

      dailyLifeImpact: `**対人関係**

高い自尊心を持つ人は、対人関係において自信を持って振る舞います。自分の意見や感情を適切に表現でき、他者との境界線を健全に設定することができます。批判やネガティブなフィードバックを受けても、それを建設的に受け止め、自己価値感が大きく揺らぐことはありません。親密な関係においては、「自分は愛されるに値する」という感覚があるため、過度な不安や嫉妬に悩まされることが少なく、安定した関係を築くことができます。

ただし、Baumeister et al. (2003) の研究によれば、高い自尊心を持つ人が「自分はより好かれ、魅力的で、良い関係を持っている」と主観的に報告する一方、客観的な測定ではこれらの信念の多くが確認されないことが示されています。つまり、高い自尊心は主観的な対人関係満足度を高めますが、客観的な関係の質を必ずしも保証するわけではありません。自分の主観的評価と他者の視点のバランスを取ることが重要です。

**仕事・学業**

職場や学校では、高い自尊心が適切な自信として表れます。新しいプロジェクトや責任を引き受けることに前向きで、挑戦を成長の機会と捉えます。会議やプレゼンテーションでは、自分のアイデアを効果的に伝え、貢献することができます。昇進や給与交渉においても、適切に自己主張ができます。

重要な点として、Baumeister et al. (2003) の研究では、高い自尊心が直接的に優れた仕事のパフォーマンスを引き起こすという証拠は限定的であることが示されています。むしろ、成功体験が自尊心を高める側面が強いです。ただし、高い自尊心の重要な利点として、**失敗後の粘り強さを促進する**ことが実験的に確認されています。つまり、高い自尊心を持つ人は、挫折してもすぐに諦めず、再挑戦する傾向があります。この粘り強さが、長期的にはキャリアの成功につながります。

**意思決定**

日常的な意思決定から重要な人生の決定まで、高い自己信頼に基づいて判断を下すことができます。必要な情報を収集しつつ、最終的には自分の判断を信頼します。他者の意見も参考にしますが、過度に依存することはありません。自分の価値観や長期的な目標に沿った選択をする傾向があります。

**ストレス対処**

高い自尊心の最も重要な機能の一つは、**ストレスに対するバッファー（緩衝材）効果**です。研究により、高い自尊心はストレスの有害な影響を軽減し、メンタルヘルスを保護することが示されています。困難な状況に直面しても、「自分には対処する力がある」という信念があるため、問題解決的なアプローチを取ることができます。一時的な挫折を経験しても、自己価値感が根本的に揺らぐことは少なく、比較的早く回復します。`,

      psychBackground: `高い自尊心（30-34点）は、メンタルヘルスの重要な保護因子です。Sowislo & Orth (2013) のメタ分析により、自尊心とうつ病（r = -0.64）および不安症（r = -0.33）の間に強い負の相関があることが確認されています。縦断研究では、高い自尊心が将来のメンタルヘルス問題のリスクを低減することが示されています。

また、高い自尊心はストレスに対する保護機能を持ちます。ストレッサーに直面したとき、高い自尊心を持つ人は、自己価値感が脅かされにくく、適応的な対処戦略（問題解決、社会的サポートの活用など）を選択しやすくなります。

ただし、Baumeister et al. (2003) の重要な知見として、高い自尊心が必ずしも客観的な成功（学業成績、仕事のパフォーマンス、対人関係の質）を直接引き起こすわけではないことが示されています。むしろ、成功体験が自尊心を高める側面が強いです。しかし、高い自尊心の明確な利点として、**失敗後の粘り強さを促進する**ことが実験的に確認されています。この粘り強さが、長期的には成功の可能性を高めます。`,

      practicalAdvice: `**現在の自尊心を維持する**

高い自尊心は貴重な心理的資源です。以下の方法で、この状態を維持し、さらに健全な方向で発展させることができます。

**健全な自尊心を保つための実践**

1. **現実的な自己評価のバランス**: 自分の強みを認識しつつ、改善の余地がある領域も受け入れます。過度な自己評価（narcissistic self-esteem）は、対人関係の問題や現実検討能力の低下につながることがあります。

2. **自己コンパッションの統合**: 研究により、自己コンパッションは自尊心よりも安定した well-being の予測因子であることが示されています。自己コンパッションは、失敗や困難な状況でも自己価値感を維持する力を与えます。「自分に優しくする」実践を取り入れましょう。

3. **成長マインドセット**: 自分の能力は固定的ではなく、努力により成長できると考えることで、失敗を脅威ではなく学習の機会と捉えられます。これにより、自尊心が成功体験だけに依存しなくなります。

**他者への配慮とバランス**

高い自尊心を持つ人は、時として自己中心的になるリスクがあります。以下の点に注意しましょう：

- **謙虚さの維持**: 自分の成功を認識しつつ、他者の貢献や運の要素も認めます。特に日本文化では謙虚さが重視されるため、文化的文脈に配慮した自己表現が重要です。
- **他者の視点の尊重**: 自分の意見に自信を持ちつつ、他者の視点や専門知識も尊重します。
- **共感と思いやり**: 自尊心が低い人の困難を理解し、サポートすることも大切です。

**継続的な自己成長**

- **新しい挑戦**: 快適ゾーン（comfort zone）を広げる新しい挑戦を続けることで、自己効力感と自尊心がさらに高まります。
- **強みの活用**: 自分の強み（VIA Character Strengths など）を認識し、それを日常生活や仕事で活用します。
- **意義ある目標**: 自分の価値観に沿った意義ある目標を設定し、それに向かって取り組むことで、自尊心がさらに安定します。

**ストレス管理**

高い自尊心はストレスバッファーとして機能しますが、非常に強いストレス（喪失、健康問題、長期的な困難）では、誰でも影響を受けます。以下の予防的対策が有効です：

- **ソーシャルサポート**: 信頼できる人間関係を維持し、困難な時には助けを求めることを厭いません。
- **セルフケアの継続**: 規則正しい生活、適度な運動、十分な睡眠、リラクゼーションなどの基本的なセルフケアを継続します。

**注意点**

- 高い自尊心を維持することと、傲慢になることは別です。他者への敬意とバランスを保ちながら、健全な自己価値感を育てることが大切です。
- 自尊心が外的な成功（地位、評価、業績）にのみ依存すると、それらを失ったときに自尊心が崩れるリスクがあります。内的な自己価値感（自分の存在そのものの価値）を育てることも重要です。`,
    },

  };

  return interpretations[level];
}

/**
 * Rosenberg Self-Esteem Scale 回答バリデーション
 */
function validateAnswerPattern(answers: number[]) {
  return validateCommon(answers, {
    expectedLength: 10,
    minValue: 1,
    maxValue: 4,
    messageType: "warning",
  });
}

// ============================================================================
// OG画像用ヘルパー関数
// ============================================================================

/**
 * レベルラベルを取得（OG画像用）
 * 例: "高自尊心 (High Self-Esteem)"
 */
export function getLevelLabel(level: RosenbergResult["level"]): string {
  const labels = {
    low: "低めの自尊心 (Low)",
    medium: "平均的な自尊心 (Average)",
    high: "高めの自尊心 (High)",
  };
  return labels[level];
}

/**
 * 短い解釈文を取得（OG画像用）
 * 2行程度の要約
 */
export function getShortInterpretation(level: RosenbergResult["level"]): string {
  const interpretations = {
    low: "自分自身を肯定的に捉えることが難しく、\n自己価値を感じにくい傾向があります。",
    medium: "自分自身に対して概ね肯定的な態度を持っていますが、\n時には自己評価が揺らぐこともあるでしょう。",
    high: "自分自身を肯定的に捉え、\n自己価値をしっかりと感じています。",
  };
  return interpretations[level];
}

// ============================================================================
// Test Configuration
// ============================================================================

/**
 * RSES (Rosenberg Self-Esteem Scale) テスト設定
 */
export const rosenbergConfig: TestConfig<RosenbergResult> = {
  id: "rosenberg",
  color: "pink",
  basePath: "/rosenberg",
  questions: rosenbergQuestions,
  scaleOptions,
  calculateScore: calculateRosenbergScore,
  validateAnswers: validateAnswerPattern,
  scaleInfo,

  // 結果ページ設定
  resultExtensions: {
    shareButtons: true,
  },

  // OG画像設定
  ogImage: {
    layoutType: "single",
    titleEn: "SELF\nESTEEM",
    category: "自尊心診断",
    description: "Rosenberg自尊心尺度\n学術的に信頼された自己評価",
    scoreDisplay: { type: "raw", min: 10, max: 40, unit: "" },
    scoreToParams: (result: RosenbergResult) => ({
      score: (result?.rawScore ?? 25).toString(),
      level: result?.level ?? "medium",
    }),
    paramsToScore: (params: URLSearchParams): RosenbergResult => {
      const rawScore = parseInt(params.get("score") || "25");
      const level = (params.get("level") as RosenbergResult["level"]) || "medium";
      const percentageScore = ((rawScore - 10) / 30) * 100;
      return {
        rawScore,
        percentageScore: Math.round(percentageScore * 10) / 10,
        level,
      };
    },
    // 🆕 単一スコア専用フィールド
    getLevelLabel: (result: RosenbergResult) => getLevelLabel(result?.level ?? "medium"),
    getShortInterpretation: (result: RosenbergResult) => getShortInterpretation(result?.level ?? "medium"),
    scoreRanges: scoreRanges.map((range) => ({
      min: range.min,
      max: range.max,
      label: range.label,
    })),
  },

  // 🆕 NEW: 1次元データ生成
  getDimensions: (result: RosenbergResult): DimensionData[] => {
    const min = 10;
    const max = 40;
    const rawScore = result?.rawScore ?? 25;
    const percentage = result?.percentageScore ?? ((rawScore - min) / (max - min)) * 100;

    return [{
      key: 'score',
      label: 'Total Score',
      score: rawScore,
      percentage: percentage,
      color: TEST_COLOR_MAP['pink'] || '#ec4899',
    }];
  },
};
