/**
 * PHQ-9 (Patient Health Questionnaire-9) - Scoring & Configuration
 *
 * PHQ-9 の採点とレベル判定
 *
 * スコア範囲: 0-27点
 * - 0-4点: 正常 (Minimal depression)
 * - 5-9点: 軽度 (Mild depression)
 * - 10-14点: 中等度 (Moderate depression)
 * - 15-19点: やや重度 (Moderately severe depression)
 * - 20-27点: 重度 (Severe depression)
 *
 * @reference Kroenke, K., Spitzer, R. L., & Williams, J. B. (2001). The PHQ-9:
 *            Validity of a brief depression severity measure. Journal of General
 *            Internal Medicine, 16(9), 606-613.
 */

import {
  phq9Questions,
  scaleOptions,
  scaleInfo,
} from "@/data/phq9-questions";
import type { TestConfig } from "./types";
import { validateAnswerPattern as validateCommon } from "./validation";
import type { DimensionData } from "@/lib/og-design/types";
import { TEST_COLOR_MAP } from "@/lib/og-design/constants";

// ============================================================================
// Types & Interfaces
// ============================================================================

// 詳細解釈の構造（Phase 5準拠 - Rosenbergと同じ）
export interface DetailedInterpretation {
  summary: string;           // 要約（約200字）
  dailyLifeImpact: string;   // 日常生活への影響（約500字）
  psychBackground: string;   // 心理学的背景（約300字）
  practicalAdvice: string;   // 実用的アドバイス（約500字）
}

/**
 * PHQ-9 の結果型
 */
export interface Phq9Result {
  rawScore: number;
  percentageScore: number;
  level: "minimal" | "mild" | "moderate" | "moderately_severe" | "severe";
  levelLabel: string;
  // NOTE: interpretation は保存せず、表示時に getInterpretation() で動的生成
  suicideRisk: boolean; // 項目9が2点以上の場合 true
  requiresUrgentCare: boolean; // スコア15点以上の場合 true
}

// ============================================================================
// Scoring Logic
// ============================================================================

/**
 * PHQ-9 スコアを計算
 * @param answers 回答配列（0-3の値）
 * @returns 計算結果
 */
export function calculatePhq9Score(answers: number[]): Phq9Result {
  if (answers.length !== 9) {
    throw new Error("PHQ-9 requires exactly 9 answers");
  }

  // PHQ-9には逆転項目なし、そのまま合計
  const rawScore = answers.reduce((sum, score) => sum + score, 0);

  // パーセンテージ計算（0-27 → 0-100%）
  const min = 0;
  const max = 27;
  const percentageScore = ((rawScore - min) / (max - min)) * 100;

  // 項目9（自殺念慮）のチェック（0-based indexなので answers[8]）
  const suicideRisk = answers[8] !== undefined && answers[8] >= 2;

  // スコア15点以上は緊急度が高い
  const requiresUrgentCare = rawScore >= 15;

  // レベル判定
  let level: Phq9Result["level"];
  let levelLabel: string;

  if (rawScore >= 20) {
    level = "severe";
    levelLabel = "重度";
  } else if (rawScore >= 15) {
    level = "moderately_severe";
    levelLabel = "やや重度";
  } else if (rawScore >= 10) {
    level = "moderate";
    levelLabel = "中等度";
  } else if (rawScore >= 5) {
    level = "mild";
    levelLabel = "軽度";
  } else {
    level = "minimal";
    levelLabel = "正常";
  }

  return {
    rawScore,
    percentageScore,
    level,
    levelLabel,
    suicideRisk,
    requiresUrgentCare,
  };
}

/**
 * 詳細解釈を取得（Phase 5準拠 - K6, Rosenbergと同じ構造）
 * 表示時に動的生成するため、localStorage に保存しない
 */
export function getDetailedInterpretation(level: Phq9Result["level"]): DetailedInterpretation {
  const interpretations: Record<Phq9Result["level"], DetailedInterpretation> = {
    minimal: {
      summary: `PHQ-9スコアが0-4点の範囲にあります。これは抑うつ症状がほとんど見られない、または最小限の状態を示しています。日常生活における気分の落ち込みは誰にでもありますが、あなたの場合、それが持続的な問題にはなっていないようです。現在の心理的健康状態は良好な範囲にあると言えます。`,

      dailyLifeImpact: `気分の落ち込みが最小限であるため、家族や友人との関係を楽しむことができ、社交的な活動にも積極的に参加できているでしょう。相手の気持ちを理解し、共感する能力も保たれています。

集中力や意欲が維持されており、日常の業務や学業に取り組むことができています。新しいタスクに対しても前向きに取り組め、生産性も通常通り保たれているはずです。疲労感も通常の範囲内で、休息によって回復できています。

判断力が保たれており、日常的な決断から重要な選択まで、適切に行うことができています。悲観的な思考に支配されることなく、バランスの取れた視点で物事を考えられています。

睡眠パターンは安定しており、食欲も正常範囲にあるでしょう。これらの基本的な生理機能が保たれていることは、全体的な健康状態が良好であることを示しています。`,

      psychBackground: `研究によると、PHQ-9スコアが0-4点の範囲にある人は、大うつ病性障害（major depressive disorder）の診断基準を満たす可能性が非常に低いことが示されています（Kroenke et al., 2001）。

ただし、この範囲にいても、人生のストレスやライフイベントによって一時的に気分が落ち込むことは正常な反応です。レジリエンス（回復力）が良好に機能していると考えられます。`,

      practicalAdvice: `現在の生活リズムや習慣を維持しましょう。運動、睡眠、栄養のバランスを保つことを続けてください。社会的なつながりを大切にし、サポートネットワークを維持してください。

ストレス管理の技術を身につけておくことは、将来的な予防になります。マインドフルネスや瞑想などのリラクゼーション法を試してみるのも良いでしょう。自分の感情に気づき、必要に応じて休息を取る習慣を持ちましょう。

生活の大きな変化（転職、引っ越し、人間関係の変化など）がある場合は、気分の変化に注意を払いましょう。2週間以上続く気分の落ち込みや興味の喪失があれば、早めに専門家に相談することを検討してください。

定期的に自分の心の状態をチェックすることは、早期発見につながります。PHQ-9のような標準化されたツールを3-6ヶ月ごとに使用するのも有効です。`,
    },

    mild: {
      summary: `PHQ-9スコアが5-9点の範囲にあります。これは軽度の抑うつ症状が見られる状態です。日常生活において、気分の落ち込みや興味・喜びの減少をいくらか経験していますが、まだ生活に大きな支障は出ていない可能性があります。ただし、放置すると症状が悪化するリスクもあるため、注意深く自分の状態を観察することが重要です。`,

      dailyLifeImpact: `軽度の抑うつ症状があるため、時々社交的な場面を避けたくなったり、人と会うことが億劫に感じられることがあるかもしれません。ただし、まだ関係性を維持することは可能で、親しい人との交流は続けられているでしょう。

集中力がやや低下したり、やる気が出にくいと感じることがあるかもしれません。しかし、通常の業務や学業はこなせており、欠勤や欠席が増えているわけではない状態です。ただし、以前よりも疲れやすく、タスクをこなすのに時間がかかると感じることがあるかもしれません。

軽度の悲観的思考が生じることがあり、小さな問題を大きく感じたり、決断に迷うことが増えているかもしれません。ただし、重要な判断はまだ適切に行えています。

睡眠の質が低下したり、食欲に変化が見られることがあります。寝つきが悪い、途中で目が覚める、または逆に眠りすぎるといった症状が時々見られるかもしれません。食欲も減少または増加の傾向が見られることがあります。`,

      psychBackground: `軽度の抑うつ症状は、ストレスフルなライフイベント、慢性的なストレス、または生活習慣の乱れによって引き起こされることがあります。

研究によると、PHQ-9スコアが5-9点の範囲にある人の中で、一部は大うつ病性障害の診断基準を満たす可能性があります（感度88%、特異度88%、カットオフ≥10）。この段階で適切な介入を行うことで、症状の進行を防ぎ、回復を早めることができます。`,

      practicalAdvice: `2週間後に再度PHQ-9を実施し、スコアの変化を確認してください。ライフスタイルの見直しとして、睡眠、運動、栄養のバランスを整えましょう。ストレスの原因を特定し、可能であれば減らす努力をしましょう。

週3-4回、30分程度の有酸素運動（ウォーキング、ジョギングなど）は、抑うつ症状の軽減に効果があります。就寝時間と起床時間を一定に保ち、寝る前のスクリーンタイムを減らしましょう。信頼できる人に自分の気持ちを話すことは、孤立感を減らし、サポートを得ることにつながります。

症状が2週間以上続き、改善の兆しが見られない場合、日常生活や仕事に支障が出始めている場合、セルフケアを試しても効果が感じられない場合は、専門家への相談を検討してください。

軽度の症状だからといって、軽視しないでください。早期の介入が、より重度の症状への進行を防ぎます。カウンセリングや認知行動療法（CBT）などの心理療法も有効です。`,
    },

    moderate: {
      summary: `PHQ-9スコアが10-14点の範囲にあります。これは中等度の抑うつ症状が見られる状態です。日常生活にかなりの支障が出始めている可能性があります。気分の落ち込み、興味や喜びの喪失、エネルギーの低下などが持続しており、これらの症状があなたの生活の質に影響を与えています。**この段階では、専門家（精神科医、心療内科医、臨床心理士など）への相談を強く推奨します。**`,

      dailyLifeImpact: `抑うつ症状により、社交的な活動を避けるようになり、人との交流が減少しているかもしれません。家族や友人との関係にも影響が出始め、孤立感を感じることが増えているでしょう。相手の気持ちを理解したり、共感する余裕が失われていると感じることがあります。

集中力の低下、意欲の減退、疲労感の増大により、仕事や学業のパフォーマンスが明らかに低下している可能性があります。タスクを完了するのに時間がかかり、ミスが増えているかもしれません。欠勤や欠席が増え始めている場合もあります。

悲観的な思考が強まり、小さな問題でも大きな障害のように感じられます。決断を下すことが困難になり、先延ばしにすることが増えているかもしれません。自分に対する否定的な評価（「自分は無価値だ」「自分は失敗者だ」など）が強まっています。

睡眠障害（不眠または過眠）が顕著になり、疲労感が取れなくなっています。食欲の変化（減少または増加）も明確で、体重の変化が見られることもあります。これらの生理的な変化が、さらに気分の悪化を招く悪循環に陥っている可能性があります。`,

      psychBackground: `PHQ-9スコアが10点以上は、大うつ病性障害（major depressive disorder, MDD）のスクリーニングカットオフ値とされています（感度88%、特異度88%）。この段階の抑うつ症状は、脳内の神経伝達物質（セロトニン、ノルアドレナリン、ドーパミンなど）のバランスが崩れている可能性があります。

中等度のうつ病は、単なる「気分の問題」ではなく、医学的な介入が必要な状態です。適切な治療（薬物療法、心理療法、またはその組み合わせ）により、症状の改善が期待できます。`,

      practicalAdvice: `**重要: 専門家への相談が必要です。** 精神科・心療内科への受診を推奨します。中等度の抑うつ症状は、専門的な治療が必要な段階です。

抗うつ薬（SSRI、SNRIなど）は、脳内の神経伝達物質のバランスを整えます。認知行動療法（CBT）、対人関係療法（IPT）などが有効です。薬物療法と心理療法の組み合わせが、最も効果的とされています。

専門的な治療を受けながら、就寝・起床時間を一定に保つ、可能な範囲で散歩などの軽い運動を取り入れる、バランスの取れた食事を心がけるなどのセルフケアも続けてください。アルコールや薬物による自己治療は避けてください（症状を悪化させます）。

家族や親しい友人に、自分の状態を伝え、サポートを求めましょう。一人で抱え込まないことが重要です。

自傷行為や自殺念慮がある場合は、直ちに医療機関を受診するか、以下に連絡してください：
- いのちの電話: 0570-783-556（24時間対応）
- 最寄りの救急医療機関

中等度のうつ病は治療可能です。適切な治療により、多くの人が回復しています。症状の改善には時間がかかることもありますが、諦めずに治療を続けることが重要です。`,
    },

    moderately_severe: {
      summary: `PHQ-9スコアが15-19点の範囲にあります。これはやや重度の抑うつ症状が見られる状態です。日常生活に深刻な支障が出ており、仕事や学業、対人関係において大きな困難を抱えている可能性が高いです。**この段階では、速やかに専門家（精神科医または心療内科医）への受診が必要です。** 適切な医療的介入なしに自力で回復することは困難な状態です。`,

      dailyLifeImpact: `深刻な抑うつ症状により、他者との交流がほとんどできなくなっている可能性があります。家族や友人との関係が損なわれ、強い孤立感と孤独感を感じているでしょう。コミュニケーションを取ることさえ負担に感じられ、社会的な引きこもりが見られることがあります。

仕事や学業の遂行が極めて困難になっています。頻繁な欠勤・欠席、長期の休職・休学を余儀なくされている場合もあるでしょう。集中力、記憶力、判断力が著しく低下し、日常的なタスクですら完了できない状態かもしれません。職場や学校からのプレッシャーが、さらに症状を悪化させている可能性があります。

悲観的で絶望的な思考に支配され、未来に対する希望を失っているかもしれません。「何をしても無駄だ」「自分には価値がない」といった強い否定的な信念が固定化しています。簡単な決断すらできず、日常生活の基本的な活動（入浴、着替え、食事など）を行うことも困難に感じられることがあります。

深刻な睡眠障害（重度の不眠または過眠）、顕著な食欲の変化、体重の大幅な増減、慢性的な疲労感、身体的な痛み（頭痛、胃痛など）が見られます。これらの身体症状が、心理的な苦痛をさらに増幅させています。`,

      psychBackground: `やや重度のうつ病は、大うつ病性障害（MDD）の診断基準を明確に満たす状態です。この段階では、脳内の神経伝達物質の不均衡が深刻化しており、認知機能、感情調節、動機づけのシステムが広範囲に障害されています。

研究によると、この重症度のうつ病は、薬物療法と心理療法の組み合わせによる集中的な治療が最も効果的です。放置すると、症状がさらに悪化し、慢性化するリスクが高まります。また、自殺リスクが顕著に増加する段階でもあるため、緊急の医療的介入が必要です。`,

      practicalAdvice: `**緊急: 直ちに専門家への受診が必要です。** 可能な限り早く、精神科・心療内科の専門医の診察を受けてください。かかりつけ医がいる場合は、まずそこで相談し、精神科への紹介状をもらうこともできます。症状が重篤で、自傷や自殺のリスクがある場合、入院治療が推奨されることもあります。

抗うつ薬の服用が強く推奨されます。効果が現れるまで2-4週間かかることがありますが、継続が重要です。薬物療法と並行して、認知行動療法（CBT）や対人関係療法（IPT）を受けることが推奨されます。症状の変化を医師と共有し、治療計画を調整していきます。

家族や親しい人に、自分の深刻な状態を伝え、医療機関への受診をサポートしてもらいましょう。一人で病院に行くのが困難な場合、誰かに付き添ってもらうことを依頼してください。

必要に応じて、休職・休学を検討してください。無理に通勤・通学を続けることは、症状を悪化させる可能性があります。人事部や学生相談室に相談し、適切なサポートを受けましょう。

自殺を考えたり、自傷行為をしたいと思う場合は、**直ちに**以下に連絡してください：
- いのちの電話: 0570-783-556（24時間対応）
- 自殺予防いのちの電話: 0120-783-556（毎月10日は24時間対応、その他の日は16-21時）
- 最寄りの救急医療機関（または119番）

やや重度のうつ病も、適切な治療により回復可能です。多くの人が、治療を通じて症状が改善し、日常生活に戻っています。回復には時間がかかりますが、専門家のサポートを受けながら、一歩ずつ進んでいきましょう。`,
    },

    severe: {
      summary: `PHQ-9スコアが20-27点の範囲にあります。これは重度の抑うつ症状が見られる、医療的に緊急性の高い状態です。日常生活のほとんどすべての領域で深刻な機能障害が生じており、自力での生活が困難な状態と考えられます。**直ちに専門医（精神科医または心療内科医）への受診、または救急医療機関への受診が必要です。** 自殺のリスクが非常に高い段階であり、緊急の医療的介入が不可欠です。`,

      dailyLifeImpact: `重度の抑うつ症状により、基本的な日常生活動作（ADL）- 入浴、着替え、食事、歯磨きなど - すら行うことが極めて困難になっている可能性があります。ベッドや布団から起き上がることさえできず、ほとんどの時間を横になって過ごしているかもしれません。

他者とのコミュニケーションがほぼ不可能になり、完全に孤立した状態にあるでしょう。家族や親しい人との関係も機能しておらず、助けを求めることさえ困難に感じられているかもしれません。

仕事や学業の継続は不可能な状態です。長期の休職・休学、または退職・退学に至っている場合もあるでしょう。

思考が極度に遅くなり、記憶力、集中力、判断力がほとんど機能していません。絶望感、無価値感、罪悪感が極度に強まり、「自分は生きる価値がない」「周囲に迷惑をかけている」「消えてしまいたい」といった強い否定的な信念に支配されています。

深刻な睡眠障害、食欲の完全な喪失（または過食）、体重の急激な変化、極度の疲労感、身体的な痛みが見られます。身体が「鉛のように重い」と感じることがあり、動くことが困難です。`,

      psychBackground: `重度のうつ病は、大うつ病性障害（MDD）の最も深刻な形態であり、生命を脅かす状態です。脳内の神経伝達物質システムが広範囲に機能不全に陥っており、認知、感情、動機づけ、生理的調節のすべてが深刻に障害されています。

この段階では、自殺リスクが極めて高く、WHO（世界保健機関）によると、重度のうつ病患者の自殺リスクは一般人口の20倍以上とされています。緊急の医療的介入、場合によっては入院治療が必要です。ただし、適切な集中的治療（薬物療法、電気けいれん療法、心理療法など）により、回復は可能です。`,

      practicalAdvice: `**緊急: 直ちに医療機関を受診してください。** 直ちに精神科・心療内科を受診するか、救急医療機関を受診してください。家族や友人に付き添ってもらい、一人で対処しようとしないでください。この重症度では、入院治療が強く推奨されます。安全な環境での集中的な治療が必要です。

**自殺念慮・自殺計画がある場合（最重要）**
**今すぐ以下に連絡してください：**
- **119番（救急車）**: 生命の危険がある場合
- **いのちの電話**: 0570-783-556（24時間対応）
- **自殺予防いのちの電話**: 0120-783-556
- **最寄りの精神科救急医療機関**
- **家族・友人・知人に助けを求める**

**あなたは一人ではありません。助けを求めることは、弱さではなく、勇気ある行動です。**

抗うつ薬の即座の投与が必要です。効果が現れるまで時間がかかりますが、継続が重要です。重度のうつ病で、薬物療法が効かない場合や、緊急性が高い場合には電気けいれん療法（ECT）が有効です。症状が安定してきたら、認知行動療法（CBT）などを開始します。入院中は、医療スタッフによる24時間体制のサポートが受けられます。

もしあなたがこのスコアを出した本人の家族や友人であれば、直ちに医療機関への受診をサポートしてください。本人が受診を拒否する場合でも、家族だけでも精神科に相談に行くことができます。本人を一人にしないでください（自殺のリスクが高いため）。

重度のうつ病も、適切な治療により回復可能です。今は絶望的に感じられても、治療を受けることで、多くの人が症状から回復し、再び充実した生活を送れるようになっています。回復への第一歩は、専門家の助けを求めることです。今日、今この瞬間から、回復への道を歩み始めることができます。

**あなたの命は尊く、かけがえのないものです。今は苦しくても、助けを求め、治療を受けることで、必ず状況は改善します。どうか、希望を捨てずに、一歩を踏み出してください。**`,
    },
  };

  return interpretations[level];
}

/**
 * PHQ-9 回答バリデーション
 * すべて0（症状なし）は許容
 */
function validateAnswerPattern(answers: number[]) {
  return validateCommon(answers, {
    expectedLength: 9,
    minValue: 0,
    maxValue: 3,
    allowedUniformValue: 0, // すべて0は正常
    messageType: "message",
  });
}

// =========================================
// 解釈コンテンツ（Phase 4で生成）
// =========================================

function getMinimalInterpretation(): string {
  return `
【要約】
PHQ-9スコアが0-4点の範囲にあります。これは抑うつ症状がほとんど見られない、または最小限の状態を示しています。日常生活における気分の落ち込みは誰にでもありますが、あなたの場合、それが持続的な問題にはなっていないようです。現在の心理的健康状態は良好な範囲にあると言えます。

【日常生活への影響】
気分の落ち込みが最小限であるため、家族や友人との関係を楽しむことができ、社交的な活動にも積極的に参加できているでしょう。相手の気持ちを理解し、共感する能力も保たれています。

集中力や意欲が維持されており、日常の業務や学業に取り組むことができています。新しいタスクに対しても前向きに取り組め、生産性も通常通り保たれているはずです。疲労感も通常の範囲内で、休息によって回復できています。

判断力が保たれており、日常的な決断から重要な選択まで、適切に行うことができています。悲観的な思考に支配されることなく、バランスの取れた視点で物事を考えられています。

睡眠パターンは安定しており、食欲も正常範囲にあるでしょう。これらの基本的な生理機能が保たれていることは、全体的な健康状態が良好であることを示しています。

【心理学的背景】
研究によると、PHQ-9スコアが0-4点の範囲にある人は、大うつ病性障害（major depressive disorder）の診断基準を満たす可能性が非常に低いことが示されています（Kroenke et al., 2001）。

ただし、この範囲にいても、人生のストレスやライフイベントによって一時的に気分が落ち込むことは正常な反応です。レジリエンス（回復力）が良好に機能していると考えられます。

【実用的アドバイス】
現在の生活リズムや習慣を維持しましょう。運動、睡眠、栄養のバランスを保つことを続けてください。社会的なつながりを大切にし、サポートネットワークを維持してください。

ストレス管理の技術を身につけておくことは、将来的な予防になります。マインドフルネスや瞑想などのリラクゼーション法を試してみるのも良いでしょう。自分の感情に気づき、必要に応じて休息を取る習慣を持ちましょう。

生活の大きな変化（転職、引っ越し、人間関係の変化など）がある場合は、気分の変化に注意を払いましょう。2週間以上続く気分の落ち込みや興味の喪失があれば、早めに専門家に相談することを検討してください。

定期的に自分の心の状態をチェックすることは、早期発見につながります。PHQ-9のような標準化されたツールを3-6ヶ月ごとに使用するのも有効です。
  `.trim();
}

function getMildInterpretation(): string {
  return `
【要約】
PHQ-9スコアが5-9点の範囲にあります。これは軽度の抑うつ症状が見られる状態です。日常生活において、気分の落ち込みや興味・喜びの減少をいくらか経験していますが、まだ生活に大きな支障は出ていない可能性があります。ただし、放置すると症状が悪化するリスクもあるため、注意深く自分の状態を観察することが重要です。

【日常生活への影響】
軽度の抑うつ症状があるため、時々社交的な場面を避けたくなったり、人と会うことが億劫に感じられることがあるかもしれません。ただし、まだ関係性を維持することは可能で、親しい人との交流は続けられているでしょう。

集中力がやや低下したり、やる気が出にくいと感じることがあるかもしれません。しかし、通常の業務や学業はこなせており、欠勤や欠席が増えているわけではない状態です。ただし、以前よりも疲れやすく、タスクをこなすのに時間がかかると感じることがあるかもしれません。

軽度の悲観的思考が生じることがあり、小さな問題を大きく感じたり、決断に迷うことが増えているかもしれません。ただし、重要な判断はまだ適切に行えています。

睡眠の質が低下したり、食欲に変化が見られることがあります。寝つきが悪い、途中で目が覚める、または逆に眠りすぎるといった症状が時々見られるかもしれません。食欲も減少または増加の傾向が見られることがあります。

【心理学的背景】
軽度の抑うつ症状は、ストレスフルなライフイベント、慢性的なストレス、または生活習慣の乱れによって引き起こされることがあります。

研究によると、PHQ-9スコアが5-9点の範囲にある人の中で、一部は大うつ病性障害の診断基準を満たす可能性があります（感度88%、特異度88%、カットオフ≥10）。この段階で適切な介入を行うことで、症状の進行を防ぎ、回復を早めることができます。

【実用的アドバイス】
2週間後に再度PHQ-9を実施し、スコアの変化を確認してください。ライフスタイルの見直しとして、睡眠、運動、栄養のバランスを整えましょう。ストレスの原因を特定し、可能であれば減らす努力をしましょう。

週3-4回、30分程度の有酸素運動（ウォーキング、ジョギングなど）は、抑うつ症状の軽減に効果があります。就寝時間と起床時間を一定に保ち、寝る前のスクリーンタイムを減らしましょう。信頼できる人に自分の気持ちを話すことは、孤立感を減らし、サポートを得ることにつながります。

症状が2週間以上続き、改善の兆しが見られない場合、日常生活や仕事に支障が出始めている場合、セルフケアを試しても効果が感じられない場合は、専門家への相談を検討してください。

軽度の症状だからといって、軽視しないでください。早期の介入が、より重度の症状への進行を防ぎます。カウンセリングや認知行動療法（CBT）などの心理療法も有効です。
  `.trim();
}

function getModerateInterpretation(): string {
  return `
【要約】
PHQ-9スコアが10-14点の範囲にあります。これは中等度の抑うつ症状が見られる状態です。日常生活にかなりの支障が出始めている可能性があります。気分の落ち込み、興味や喜びの喪失、エネルギーの低下などが持続しており、これらの症状があなたの生活の質に影響を与えています。**この段階では、専門家（精神科医、心療内科医、臨床心理士など）への相談を強く推奨します。**

【日常生活への影響】
抑うつ症状により、社交的な活動を避けるようになり、人との交流が減少しているかもしれません。家族や友人との関係にも影響が出始め、孤立感を感じることが増えているでしょう。相手の気持ちを理解したり、共感する余裕が失われていると感じることがあります。

集中力の低下、意欲の減退、疲労感の増大により、仕事や学業のパフォーマンスが明らかに低下している可能性があります。タスクを完了するのに時間がかかり、ミスが増えているかもしれません。欠勤や欠席が増え始めている場合もあります。

悲観的な思考が強まり、小さな問題でも大きな障害のように感じられます。決断を下すことが困難になり、先延ばしにすることが増えているかもしれません。自分に対する否定的な評価（「自分は無価値だ」「自分は失敗者だ」など）が強まっています。

睡眠障害（不眠または過眠）が顕著になり、疲労感が取れなくなっています。食欲の変化（減少または増加）も明確で、体重の変化が見られることもあります。これらの生理的な変化が、さらに気分の悪化を招く悪循環に陥っている可能性があります。

【心理学的背景】
PHQ-9スコアが10点以上は、大うつ病性障害（major depressive disorder, MDD）のスクリーニングカットオフ値とされています（感度88%、特異度88%）。この段階の抑うつ症状は、脳内の神経伝達物質（セロトニン、ノルアドレナリン、ドーパミンなど）のバランスが崩れている可能性があります。

中等度のうつ病は、単なる「気分の問題」ではなく、医学的な介入が必要な状態です。適切な治療（薬物療法、心理療法、またはその組み合わせ）により、症状の改善が期待できます。

【実用的アドバイス】
**重要: 専門家への相談が必要です。** 精神科・心療内科への受診を推奨します。中等度の抑うつ症状は、専門的な治療が必要な段階です。

抗うつ薬（SSRI、SNRIなど）は、脳内の神経伝達物質のバランスを整えます。認知行動療法（CBT）、対人関係療法（IPT）などが有効です。薬物療法と心理療法の組み合わせが、最も効果的とされています。

専門的な治療を受けながら、就寝・起床時間を一定に保つ、可能な範囲で散歩などの軽い運動を取り入れる、バランスの取れた食事を心がけるなどのセルフケアも続けてください。アルコールや薬物による自己治療は避けてください（症状を悪化させます）。

家族や親しい友人に、自分の状態を伝え、サポートを求めましょう。一人で抱え込まないことが重要です。

自傷行為や自殺念慮がある場合は、直ちに医療機関を受診するか、以下に連絡してください：
- いのちの電話: 0570-783-556（24時間対応）
- 最寄りの救急医療機関

中等度のうつ病は治療可能です。適切な治療により、多くの人が回復しています。症状の改善には時間がかかることもありますが、諦めずに治療を続けることが重要です。
  `.trim();
}

function getModeratelySevereInterpretation(): string {
  return `
【要約】
PHQ-9スコアが15-19点の範囲にあります。これはやや重度の抑うつ症状が見られる状態です。日常生活に深刻な支障が出ており、仕事や学業、対人関係において大きな困難を抱えている可能性が高いです。**この段階では、速やかに専門家（精神科医または心療内科医）への受診が必要です。** 適切な医療的介入なしに自力で回復することは困難な状態です。

【日常生活への影響】
深刻な抑うつ症状により、他者との交流がほとんどできなくなっている可能性があります。家族や友人との関係が損なわれ、強い孤立感と孤独感を感じているでしょう。コミュニケーションを取ることさえ負担に感じられ、社会的な引きこもりが見られることがあります。

仕事や学業の遂行が極めて困難になっています。頻繁な欠勤・欠席、長期の休職・休学を余儀なくされている場合もあるでしょう。集中力、記憶力、判断力が著しく低下し、日常的なタスクですら完了できない状態かもしれません。職場や学校からのプレッシャーが、さらに症状を悪化させている可能性があります。

悲観的で絶望的な思考に支配され、未来に対する希望を失っているかもしれません。「何をしても無駄だ」「自分には価値がない」といった強い否定的な信念が固定化しています。簡単な決断すらできず、日常生活の基本的な活動（入浴、着替え、食事など）を行うことも困難に感じられることがあります。

深刻な睡眠障害（重度の不眠または過眠）、顕著な食欲の変化、体重の大幅な増減、慢性的な疲労感、身体的な痛み（頭痛、胃痛など）が見られます。これらの身体症状が、心理的な苦痛をさらに増幅させています。

【心理学的背景】
やや重度のうつ病は、大うつ病性障害（MDD）の診断基準を明確に満たす状態です。この段階では、脳内の神経伝達物質の不均衡が深刻化しており、認知機能、感情調節、動機づけのシステムが広範囲に障害されています。

研究によると、この重症度のうつ病は、薬物療法と心理療法の組み合わせによる集中的な治療が最も効果的です。放置すると、症状がさらに悪化し、慢性化するリスクが高まります。また、自殺リスクが顕著に増加する段階でもあるため、緊急の医療的介入が必要です。

【実用的アドバイス】
**緊急: 直ちに専門家への受診が必要です。** 可能な限り早く、精神科・心療内科の専門医の診察を受けてください。かかりつけ医がいる場合は、まずそこで相談し、精神科への紹介状をもらうこともできます。症状が重篤で、自傷や自殺のリスクがある場合、入院治療が推奨されることもあります。

抗うつ薬の服用が強く推奨されます。効果が現れるまで2-4週間かかることがありますが、継続が重要です。薬物療法と並行して、認知行動療法（CBT）や対人関係療法（IPT）を受けることが推奨されます。症状の変化を医師と共有し、治療計画を調整していきます。

家族や親しい人に、自分の深刻な状態を伝え、医療機関への受診をサポートしてもらいましょう。一人で病院に行くのが困難な場合、誰かに付き添ってもらうことを依頼してください。

必要に応じて、休職・休学を検討してください。無理に通勤・通学を続けることは、症状を悪化させる可能性があります。人事部や学生相談室に相談し、適切なサポートを受けましょう。

自殺を考えたり、自傷行為をしたいと思う場合は、**直ちに**以下に連絡してください：
- いのちの電話: 0570-783-556（24時間対応）
- 自殺予防いのちの電話: 0120-783-556（毎月10日は24時間対応、その他の日は16-21時）
- 最寄りの救急医療機関（または119番）

やや重度のうつ病も、適切な治療により回復可能です。多くの人が、治療を通じて症状が改善し、日常生活に戻っています。回復には時間がかかりますが、専門家のサポートを受けながら、一歩ずつ進んでいきましょう。
  `.trim();
}

function getSevereInterpretation(): string {
  return `
【要約】
PHQ-9スコアが20-27点の範囲にあります。これは重度の抑うつ症状が見られる、医療的に緊急性の高い状態です。日常生活のほとんどすべての領域で深刻な機能障害が生じており、自力での生活が困難な状態と考えられます。**直ちに専門医（精神科医または心療内科医）への受診、または救急医療機関への受診が必要です。** 自殺のリスクが非常に高い段階であり、緊急の医療的介入が不可欠です。

【日常生活への影響】
重度の抑うつ症状により、基本的な日常生活動作（ADL）- 入浴、着替え、食事、歯磨きなど - すら行うことが極めて困難になっている可能性があります。ベッドや布団から起き上がることさえできず、ほとんどの時間を横になって過ごしているかもしれません。

他者とのコミュニケーションがほぼ不可能になり、完全に孤立した状態にあるでしょう。家族や親しい人との関係も機能しておらず、助けを求めることさえ困難に感じられているかもしれません。

仕事や学業の継続は不可能な状態です。長期の休職・休学、または退職・退学に至っている場合もあるでしょう。

思考が極度に遅くなり、記憶力、集中力、判断力がほとんど機能していません。絶望感、無価値感、罪悪感が極度に強まり、「自分は生きる価値がない」「周囲に迷惑をかけている」「消えてしまいたい」といった強い否定的な信念に支配されています。

深刻な睡眠障害、食欲の完全な喪失（または過食）、体重の急激な変化、極度の疲労感、身体的な痛みが見られます。身体が「鉛のように重い」と感じることがあり、動くことが困難です。

【心理学的背景】
重度のうつ病は、大うつ病性障害（MDD）の最も深刻な形態であり、生命を脅かす状態です。脳内の神経伝達物質システムが広範囲に機能不全に陥っており、認知、感情、動機づけ、生理的調節のすべてが深刻に障害されています。

この段階では、自殺リスクが極めて高く、WHO（世界保健機関）によると、重度のうつ病患者の自殺リスクは一般人口の20倍以上とされています。緊急の医療的介入、場合によっては入院治療が必要です。ただし、適切な集中的治療（薬物療法、電気けいれん療法、心理療法など）により、回復は可能です。

【実用的アドバイス】
**緊急: 直ちに医療機関を受診してください。** 直ちに精神科・心療内科を受診するか、救急医療機関を受診してください。家族や友人に付き添ってもらい、一人で対処しようとしないでください。この重症度では、入院治療が強く推奨されます。安全な環境での集中的な治療が必要です。

**自殺念慮・自殺計画がある場合（最重要）**
**今すぐ以下に連絡してください：**
- **119番（救急車）**: 生命の危険がある場合
- **いのちの電話**: 0570-783-556（24時間対応）
- **自殺予防いのちの電話**: 0120-783-556
- **最寄りの精神科救急医療機関**
- **家族・友人・知人に助けを求める**

**あなたは一人ではありません。助けを求めることは、弱さではなく、勇気ある行動です。**

抗うつ薬の即座の投与が必要です。効果が現れるまで時間がかかりますが、継続が重要です。重度のうつ病で、薬物療法が効かない場合や、緊急性が高い場合には電気けいれん療法（ECT）が有効です。症状が安定してきたら、認知行動療法（CBT）などを開始します。入院中は、医療スタッフによる24時間体制のサポートが受けられます。

もしあなたがこのスコアを出した本人の家族や友人であれば、直ちに医療機関への受診をサポートしてください。本人が受診を拒否する場合でも、家族だけでも精神科に相談に行くことができます。本人を一人にしないでください（自殺のリスクが高いため）。

重度のうつ病も、適切な治療により回復可能です。今は絶望的に感じられても、治療を受けることで、多くの人が症状から回復し、再び充実した生活を送れるようになっています。回復への第一歩は、専門家の助けを求めることです。今日、今この瞬間から、回復への道を歩み始めることができます。

**あなたの命は尊く、かけがえのないものです。今は苦しくても、助けを求め、治療を受けることで、必ず状況は改善します。どうか、希望を捨てずに、一歩を踏み出してください。**
  `.trim();
}

// ============================================================================
// Test Configuration
// ============================================================================

/**
 * PHQ-9 (Patient Health Questionnaire-9) テスト設定
 */
export const phq9Config: TestConfig<Phq9Result> = {
  id: "phq9",
  color: "orange", // メンタルヘルス系はorangeで統一
  basePath: "/phq9",
  questions: phq9Questions,
  scaleOptions,
  calculateScore: calculatePhq9Score,
  validateAnswers: validateAnswerPattern,
  scaleInfo,

  // 結果ページ設定
  scoreDisplay: {
    type: "progress",
    maxScore: 27,
  },
  resultAlerts: [
    {
      type: "crisis",
      condition: (result: Phq9Result) => result.suicideRisk === true,
      title: "⚠️ 緊急: 自殺念慮が検出されました",
      message:
        "あなたの回答から、深刻な危機的状況が示唆されています。すぐに専門家に相談するか、以下の相談窓口に連絡してください。",
      contacts: [
        { name: "いのちの電話", number: "0570-783-556" },
        { name: "こころの健康相談統一ダイヤル", number: "0570-064-556" },
      ],
    },
    {
      type: "urgent",
      condition: (result: Phq9Result) => result.requiresUrgentCare === true,
      title: "専門家への相談を推奨します",
      message:
        "あなたのスコアは15点以上です。中等度以上のうつ症状が示唆されています。精神科医または心療内科医への受診をご検討ください。",
    },
  ],
  resultExtensions: {
    shareButtons: true,
  },

  // OG画像設定
  ogImage: {
    layoutType: "single",
    titleEn: "PHQ-9",
    category: "うつ病スクリーニング",
    description: "抑うつ症状の評価\n医学的エビデンスに基づく",
    scoreDisplay: { type: "raw", min: 0, max: 27, unit: "" },
    scoreToParams: (result: Phq9Result) => ({
      score: (result?.rawScore ?? 7).toString(),
    }),
    paramsToScore: (params: URLSearchParams) => ({
      score: parseInt(params.get("score") || "7"),
    }),
  },

  // 🆕 NEW: 1次元データ生成（レベルベースの色付き）
  getDimensions: (result: Phq9Result): DimensionData[] => {
    const min = 0;
    const max = 27;
    const rawScore = result?.rawScore ?? 7;
    const percentage = result?.percentageScore ?? ((rawScore - min) / (max - min)) * 100;

    // レベルに応じた色を決定
    let color: string;
    if (result.level === "severe" || result.level === "moderately_severe") {
      color = '#f97316'; // orange
    } else if (result.level === "moderate") {
      color = '#ec4899'; // pink
    } else if (result.level === "mild") {
      color = '#3b82f6'; // blue
    } else {
      color = '#10b981'; // green
    }

    return [{
      key: 'score',
      label: 'Total Score',
      score: rawScore,
      percentage: percentage,
      color: color,
    }];
  },
};
